# 现货策略创建页面修复文档 V2

## 修复时间
2024-12-31

## 修复的问题

### 1. 层数选择无法正确工作
**问题描述**：
- 层数选择器使用 Controller 包装，但 value 属性设置为字符串类型 `field.value?.toString() || "10"`
- onChange 回调中虽然转换为数字，但可能存在类型不匹配问题
- 表单验证期望 layers 字段为数字类型

**修复方案**：
- 确保 Select 组件的 value 使用字符串，但在所有处理逻辑中正确转换为数字
- 在表单默认值中设置 layers 为数字类型 10
- 在策略类型切换时正确设置 layers 的默认值

### 2. 触发价格验证错误
**问题描述**：
- 触发价格字段在冰山策略的条件渲染块内，但表单验证要求所有策略类型都必须有触发价格
- 导致提交时出现"冰山策略需要设置触发价格"的错误

**修复方案**：
- 将触发价格字段移出条件渲染块，让所有策略类型都能输入触发价格
- 保持表单验证逻辑不变，确保冰山策略必须有触发价格

## 重构内容

### 1. 创建新的策略页面组件
创建了 `StrategiesNew.tsx`，主要改进：

1. **表单初始化优化**
   - 明确设置所有字段的默认值，包括 trigger_price: 0
   - 确保 layers 字段初始值为数字类型 10

2. **表单字段布局调整**
   - 触发价格字段放在策略类型选择后，所有策略都可见
   - 简单策略和冰山策略的特有字段分别在不同的条件渲染块中

3. **策略类型切换逻辑优化**
   - 使用 useEffect 监听 watchedType 变化
   - 切换时清除验证错误并重置相关字段
   - 确保层级分布正确计算和设置

4. **数据提交处理改进**
   - 确保所有数字类型字段都正确转换
   - 添加详细的错误日志输出
   - 优化错误提示信息

### 2. 路由配置更新
在 `App.tsx` 中导入新的策略页面组件：
```typescript
import { StrategiesNew as Strategies } from '@/pages/StrategiesNew';
```

## 测试要点

1. **层数选择测试**
   - 创建冰山策略时，选择不同层数（5-10层）
   - 确认层数能正确保存和显示
   - 验证层级分布预览是否正确更新

2. **触发价格测试**
   - 所有策略类型都能输入触发价格
   - 提交时不再出现"冰山策略需要设置触发价格"错误

3. **策略类型切换测试**
   - 在不同策略类型间切换
   - 确认字段显示/隐藏正确
   - 验证表单数据不会混乱

4. **数据提交测试**
   - 创建各种类型的策略
   - 验证提交的数据格式正确
   - 确认策略创建成功

## 后续优化建议

1. **添加表单数据持久化**
   - 用户输入过程中意外关闭弹窗时，保存已输入的数据

2. **增加实时价格获取**
   - 在选择交易对后，自动获取当前市场价格作为触发价格参考

3. **优化层级分布算法**
   - 提供更多预设的层级分布方案
   - 允许用户自定义每层的数量分配

4. **添加策略模板**
   - 保存常用的策略配置作为模板
   - 快速创建相似的策略